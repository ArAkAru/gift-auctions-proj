# Gift Auctions

Система многораундовых аукционов для распределения товаров (подарков) между участниками.

## Концепция

В отличие от классического аукциона, где один товар достаётся одному победителю, здесь **N товаров** распределяются между участниками через **несколько раундов**. В каждом раунде топ-K участников получают товары, остальные продолжают борьбу в следующих раундах.

## Основная логика

### Жизненный цикл аукциона

```
DRAFT → SCHEDULED → ACTIVE → COMPLETED
                 ↘         ↗
                  CANCELLED
```

- **DRAFT** — черновик, можно редактировать
- **SCHEDULED** — запланирован на определённое время
- **ACTIVE** — идут торги
- **COMPLETED** — все раунды завершены
- **CANCELLED** — отменён

### Механика раундов

1. **Старт раунда** — запускается таймер, участники делают ставки
2. **Ставки** — участники повышают свои ставки, рейтинг обновляется в реальном времени
3. **Завершение раунда** — определяются топ-N победителей
4. **Распределение** — победители получают товары, их средства списываются
5. **Переход** — проигравшие переносятся в следующий раунд со своими ставками (деньги остаются заблокированными)

### Пример

Допустим, аукцион с 100 товарами, 10 раундов, по 10 товаров за раунд:

| Раунд | Участников | Победители | Получают товар | Остаётся |
|-------|------------|------------|----------------|----------|
| 1     | 50         | Топ-10     | 10 товаров     | 40       |
| 2     | 40         | Топ-10     | 10 товаров     | 30       |
| ...   | ...        | ...        | ...            | ...      |
| 10    | 10         | Топ-10     | 10 товаров     | 0        |

## Сущности

### Auction (Аукцион)

| Поле | Описание |
|------|----------|
| `name` | Название аукциона |
| `totalRounds` | Общее количество раундов |
| `firstRoundDuration` | Длительность первого раунда (сек) |
| `regularRoundDuration` | Длительность обычных раундов (сек) |
| `minBid` | Минимальная ставка |
| `minBidIncrement` | Минимальный шаг повышения ставки |
| `itemsPerRound` | Сколько товаров разыгрывается за раунд |
| `totalItems` | Общее количество товаров |
| `antiSnipingThreshold` | Порог срабатывания anti-sniping (сек до конца) |
| `antiSnipingExtension` | На сколько продлевать раунд (сек) |
| `maxAntiSnipingExtensions` | Максимум продлений за раунд |

### Bidder (Участник)

| Поле | Описание |
|------|----------|
| `username` | Имя пользователя |
| `balance.available` | Доступный баланс |
| `balance.held` | Заблокированный баланс (активные ставки) |

### Bid (Ставка)

| Поле | Описание |
|------|----------|
| `auctionId` | ID аукциона |
| `bidderId` | ID участника |
| `amount` | Сумма ставки |
| `status` | ACTIVE / WON / LOST |
| `wonInRound` | В каком раунде выиграл (если WON) |

## Допущения и ограничения

### 1. Один участник — одна активная ставка

Участник может иметь **только одну активную ставку** на аукцион. При повышении обновляется существующая ставка, а не создаётся новая.

**Почему:** упрощает логику рейтинга и предотвращает манипуляции с несколькими ставками от одного лица.

### 2. Баланс делится на available и held

При ставке деньги **блокируются** (переходят из `available` в `held`):
- Проигравшие в раунде — деньги остаются заблокированными для следующего раунда
- Выигравшие — деньги **списываются** из `held`
- Проигравшие в последнем раунде — деньги **возвращаются** в `available`

**Почему:** участник не может потратить деньги, которыми уже "играет" в аукционе.

### 3. Anti-Sniping защита

Если ставка в топ-N поступает в последние `antiSnipingThreshold` секунд, раунд продлевается на `antiSnipingExtension` секунд.

**Ограничения:**
- Максимум `maxAntiSnipingExtensions` продлений за раунд (по умолчанию 10)
- Продление срабатывает только для ставок, попадающих в призовую зону

**Почему:** без ограничения раунд может длиться бесконечно, если участники постоянно перебивают друг друга.

### 4. Ранжирование ставок

При равных суммах приоритет у более **ранней** ставки.

```
Сортировка: amount DESC, createdAt ASC
```

**Почему:** мотивирует делать ставки раньше, а не ждать последней секунды.

### 5. itemsPerRound × totalRounds ≤ totalItems

При создании аукциона проверяется, что запланированное количество раздаваемых товаров не превышает общее количество.

**Пример:**
- ✅ 10 раундов × 10 товаров = 100 ≤ 100 товаров
- ❌ 10 раундов × 11 товаров = 110 > 100 товаров — ошибка

### 6. Досрочное завершение

Если активных ставок меньше чем `itemsPerRound`, аукцион может завершиться раньше — все оставшиеся получают товары.

### 7. Первый раунд может быть длиннее

`firstRoundDuration` может отличаться от `regularRoundDuration`, чтобы дать участникам больше времени на первоначальные ставки.

## API Endpoints

### Аукционы

| Метод | Endpoint | Описание |
|-------|----------|----------|
| POST | `/auctions` | Создать аукцион |
| GET | `/auctions` | Список аукционов |
| GET | `/auctions/:id` | Детали аукциона (+ `timeRemaining`) |
| POST | `/auctions/:id/start` | Запустить аукцион |
| POST | `/auctions/:id/bids` | Сделать ставку |
| GET | `/auctions/:id/bids` | Все ставки аукциона |
| GET | `/auctions/:id/leaderboard` | Рейтинг участников |
| GET | `/auctions/:id/stats` | Статистика |
| GET | `/auctions/:id/winners` | Победители |

### Участники

| Метод | Endpoint | Описание |
|-------|----------|----------|
| POST | `/bidders` | Создать участника |
| GET | `/bidders` | Список участников |
| GET | `/bidders/:id` | Детали участника |
| POST | `/bidders/:id/deposit` | Пополнить баланс |

## Защита системы

### От параллельных запросов (Race Conditions)

**Distributed Lock** на базе MongoDB предотвращает:
- Двойную блокировку денег при одновременных ставках
- Двойное завершение раунда
- Двойной старт аукциона

### От падений (Crash Recovery)

**MongoDB транзакции** гарантируют атомарность:
- Блокировка денег + сохранение ставки — одна транзакция
- Определение победителей + списание средств + переход раунда — одна транзакция

При падении посреди операции — все изменения откатываются.

### От зависших блокировок

**TTL Index** автоматически удаляет истёкшие блокировки через 30 секунд.

## Запуск

### Требования

- Node.js 18+
- MongoDB 6+ (обязательно **Replica Set** для транзакций)
- Docker & Docker Compose

### Docker

```bash
docker-compose up -d
```

### Локально

```bash
npm install
npm run dev
```

### Скрипты

```bash
npm run fill       # Заполнить тестовыми данными
npm run simulate   # Запустить симуляцию ботов
npm run stress     # Стресс-тест
```

## Технологии

- **Backend:** Node.js, Express, TypeScript
- **Database:** MongoDB + Mongoose
- **Транзакции:** MongoDB Replica Set
- **Блокировки:** Custom distributed lock на MongoDB

## Что можно было бы улучшить

- [ ] WebSocket для real-time обновлений рейтинга
- [ ] Разные стратегии ботов в симуляции (снайпер, агрессивный и т.д.)
- [ ] Гибкая настройка распределения товаров по раундам
- [ ] Аутентификация и авторизация (bidderId в теле запроса)
- [ ] Валидация входных данных (защита от XSS, NoSQL Injection и тп)
- [ ] Время — UTC, клиент отвечает за локализацию
- [ ] Логи, метрики и тп - все что связано с реальным проектом на проде
- [ ] Перенести distributed locks на Redis (Redlock) — быстрее и надёжнее чем MongoDB для этой задачи
- [ ] Создать отдельную таблицу Transactions - чтобы хранить всю историю операций для пользователя
